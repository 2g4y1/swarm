#!/bin/bash
getdbsize="$(du -sb $hornetdir/mainnetdb | cut -f1)"
let dbsize=getdbsize/1000000
if [ dbsize -gt $maxdbsize ]; then
    pruningindex="$(cat $swarmdir/log/pruning.log | sed -n -e '1{p;q}')"
    if [ ! -n "$pruningindex" ] && [ ! $pruningindex -gt 0 ]; then
        pruningindex="$(curl -s http://localhost:14265 -X POST -H 'Content-Type: application/json' -H 'X-IOTA-API-Version: 1' -d '{"command": "getNodeInfo"}' | jq '.milestoneStartIndex')"
    fi
    lsmi="$(curl -s http://localhost:14265 -X POST -H 'Content-Type: application/json' -H 'X-IOTA-API-Version: 1' -d '{"command": "getNodeInfo"}' | jq '.latestSolidSubtangleMilestoneIndex')"
    let msdif=$lsmi-$pruningindex
    if [ $msdif -gt 40000 ]; then
        let pruningindex=$pruningindex+8640
        curl -s http://localhost:14265 -X POST -H 'Content-Type: application/json' -H 'X-IOTA-API-Version: 1' -d '{"command": "pruneDatabase" ,"pruningIndex": '$pruningindex'}'
        let maxdbsize=$maxdbsize+($dbsize-$maxdbsize)
        sudo sed -i 's/maxdbsize=.*/maxdbsize='$maxdbsize'/' $configs/hornet.cfg
        echo $pruningindex > $swarmdir/log/pruning.log
    fi
fi
