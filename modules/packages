#!/bin/bash
# Add snap to enviroment file
if ! grep -q /snap/bin "$envfile"; then
    echo "PATH=\"$PATH:/snap/bin\"" > $envfile
    source $envfile
fi
checkPackage="$(dpkg-query -W -f='${Status}\n' apache2-utils)"
if [[ "$checkPackage" == *"install ok installed"* ]]; then
    apache2Utils=true
fi

if [ ! -x "$(command -v curl)" ] || [ ! -x "$(command -v jq)" ] || [ ! -x "$(command -v nano)" ] || [ "$apache2Utils" != "true" ] || [ ! -x "$(command -v sponge)" ] | [ ! -x "$(command -v snap)" ]; then
    {
        echo 0
        # Check if a package is missing
        if ! [ -x "$(command -v curl)" ]; then
                sudo apt -qq install curl -y > /dev/null 2>&1
        fi
        echo 15
        sleep 0.25
        if ! [ -x "$(command -v jq)" ]; then
            sudo apt -qq install jq -y > /dev/null 2>&1
        fi
        echo 30
        sleep 0.25
        if ! [ -x "$(command -v nano)" ]; then
            sudo apt -qq install nano -y > /dev/null 2>&1
        fi
        echo 45
        sleep 0.25
        if [ "$apache2Utils" != "true" ]; then
            sudo apt -qq install apache2-utils -y > /dev/null 2>&1
        fi
        echo 60
        sleep 0.25
        if ! [ -x "$(command -v sponge)" ]; then
            sudo apt -qq install moreutils -y > /dev/null 2>&1
        fi
        echo 75
        sleep 0.25
        if ! [ -x "$(command -v snap)" ]; then
            echo -e $text_yellow && echo "Installing necessary package snap..." && echo -e $text_reset
            sudo apt -qq install snapd -y > /dev/null 2>&1
        fi
        echo 100
        sleep 0.25
    } | whiptail --gauge "Please wait while SWARM is installing all packages..." 6 65 0
fi