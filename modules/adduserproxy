#!/bin/bash

if [ -d "/etc/nginx" ]; then
    if [ ! -f "/etc/nginx/dash/.htpasswd" ]; then
        if [ ! -d "/etc/nginx/dash" ]; then
            sudo mkdir -p /etc/nginx/dash
        fi
        sudo touch /etc/nginx/dash/.htpasswd
    fi
    if [ ! -f "/etc/nginx/api/.htpasswd" ]; then
        if [ ! -d "/etc/nginx/api" ]; then
            sudo mkdir -p /etc/nginx/api
        fi
        sudo touch /etc/nginx/api/.htpasswd
    fi
else
    whiptail --title "Proxy Menu" --msgbox "Please deploy the reverse proxy first!" 8 65
fi

CHOICE=$(
    whiptail --title "Proxy Menu" --menu "\nChoose an option:" 20 65 10 \
    "1)" "Add new dashboard user" \
    "2)" "Add new API user" \
    "3)" "Add new user for Dash/API" 3>&2 2>&1 1>&3
)

newusername=$(whiptail --inputbox "Please enter a username:" 8 65 --title "Proxy Menu" 3>&1 1>&2 2>&3)
if [ ! -z $newusername ]; then
    newuserpw=$(whiptail --passwordbox "Please enter a secure password:" 8 65 --title "Proxy Menu" 3>&1 1>&2 2>&3)
    if [ ! -z $newuserpw ]; then
        newuserpw="$(mkpasswd -m sha-512 $newuserpw)"
    else
        whiptail --title "Proxy Menu" --msgbox "Please set a password!" 8 65
        CHOICE=0
    fi
else
    whiptail --title "Proxy Menu" --msgbox "Please set a username!" 8 65
    CHOICE=0
fi
                                                                        

case $CHOICE in
    "1)")
        echo "$newusername:$newuserpw" >> /etc/nginx/dash/.htpasswd
        sudo systemctl reload nginx
    ;;
    "2)")
        echo "$newusername:$newuserpw" >> /etc/nginx/api/.htpasswd
        sudo systemctl reload nginx
    ;;
    "3)")
        echo "$newusername:$newuserpw" >> /etc/nginx/dash/.htpasswd
        echo "$newusername:$newuserpw" >> /etc/nginx/api/.htpasswd
        sudo systemctl reload nginx
    ;;
esac

# Unset all var
unset aupopt
unset adduserproxy
unset newusername
unset newuserpw