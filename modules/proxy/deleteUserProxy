#!/bin/bash

if [ -d "/etc/nginx" ]; then
    if [ ! -f "$configs/.dashboard_htpasswd" ]; then
        sudo touch $configs/.dashboard_htpasswd
    fi
    if [ ! -f "$configs/.api_htpasswd" ]; then
        sudo touch $configs/.api_htpasswd
    fi
else
    whiptail --title "Proxy Menu" --msgbox "Please deploy the reverse proxy first!" 8 65
fi

CHOICE=$(
    whiptail --title "Proxy Menu" --menu "\nChoose an option:" 20 65 10 \
    if [ "$apiProtection" = "true" ]; then
        "1)" "Delete dashboard user" \
        "2)" "Delete API user" 3>&2 2>&1 1>&3
    else
        "1)" "Delete dashboard user" 3>&2 2>&1 1>&3
    fi
)

deleteUsername=$(whiptail --inputbox "Please enter the user to be deleted:" 8 65 --title "Proxy Menu" 3>&1 1>&2 2>&3)
if [ ! -z $deleteUsername ]; then
    case $CHOICE in
        "1)")
            delUser="$(sudo htpasswd -D $configs/.dashboard_htpasswd $deleteUsername)"
            if [[ "$delUser" != *"not found"* ]]; then
                delUserDashboard=true
            else
                whiptail --title "Proxy Menu" --msgbox "User $deleteUsername not found in Dashboard auth!" 8 65
            fi
            delUser="$(sudo htpasswd -D $configs/.api_htpasswd $deleteUsername)"
            if [[ "$delUser" != *"not found"* ]]; then
                delUserApi=true
            else
                whiptail --title "Proxy Menu" --msgbox "User $deleteUsername not found in API auth!" 8 65
            fi
            if [ "$delUserDashboard" = "true" ] && [ "$delUserApi" = "true" ]; then
                whiptail --title "Proxy Menu" --msgbox "User $deleteUsername successfully deleted from Dashboard/API auth!" 8 65
            fi
            sudo systemctl reload nginx
        ;;
        "2)")
            delUser="$(sudo htpasswd -D $configs/.api_htpasswd $deleteUsername)"
            if [[ "$delUser" != *"not found"* ]]; then
                delUserApi=true
            else
                whiptail --title "Proxy Menu" --msgbox "User $deleteUsername not found in API auth!" 8 65
            fi
            if [ "$delUserApi" = "true" ]; then
                whiptail --title "Proxy Menu" --msgbox "User $deleteUsername successfully deleted from API auth!" 8 65
            fi
            sudo systemctl reload nginx
        ;;
    esac
else
    whiptail --title "Proxy Menu" --msgbox "Incorrect input, please enter username!" 8 65
    CHOICE=0
fi