#!/bin/bash

if [ -d "$plugins/proxy" ] && [ -d "/etc/nginx" ]; then
    if [ ! -f "$plugins/proxy/dashboard_htpasswd" ]; then
        sudo touch $plugins/proxy/dashboard_htpasswd
    fi
    if [ ! -f "$plugins/proxy/api_htpasswd" ]; then
        sudo touch $plugins/proxy/api_htpasswd
    fi
else
    whiptail --title "Proxy Menu" --msgbox "Please deploy the reverse proxy first!" 8 65
fi

CHOICE=$(
    whiptail --title "Proxy Menu" --menu "\nChoose an option:" 20 65 10 \
    "1)" "Add new dashboard user" \
    "2)" "Add new API user" \
    "3)" "Add new user for the Dashboard/API" 3>&2 2>&1 1>&3
)

newUsername=$(whiptail --inputbox "Please enter a username:" 8 65 --title "Proxy Menu" 3>&1 1>&2 2>&3)
if [ ! -z $newUsername ]; then
    newUserPw=$(whiptail --passwordbox "Please enter a secure password:" 8 65 --title "Proxy Menu" 3>&1 1>&2 2>&3)
    if [ ! -z $newUserPw ]; then
        newUserPw="$(mkpasswd -m sha-512 $newUserPw)"
    else
        whiptail --title "Proxy Menu" --msgbox "Please set a password!" 8 65
        CHOICE=0
    fi
else
    whiptail --title "Proxy Menu" --msgbox "Please set a username!" 8 65
    CHOICE=0
fi
                                                                        

case $CHOICE in
    "1)")
        echo "$newUsername:$newUserPw" >> $plugins/proxy/dashboard_htpasswd
        sudo systemctl reload nginx
        whiptail --title "Proxy Menu" --msgbox "New user added for the dashboard!" 8 65
    ;;
    "2)")
        echo "$newUsername:$newUserPw" >> $plugins/proxy/api_htpasswd
        sudo systemctl reload nginx
        whiptail --title "Proxy Menu" --msgbox "New user added for the API!" 8 65
    ;;
    "3)")
        echo "$newUsername:$newUserPw" >> $plugins/proxy/dashboard_htpasswd
        echo "$newusername:$newUserPw" >> $plugins/proxy/api_htpasswd
        sudo systemctl reload nginx
        whiptail --title "Proxy Menu" --msgbox "New user added for the dashboard & API!" 8 65
    ;;
esac

# Unset all var
unset newUsername
unset newUserPw