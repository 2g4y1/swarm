#!/bin/bash
source $configs/hornet.cfg
source $configs/swarm.cfg

if [ ! -z "$domain" ]; then
    if [ "$apiPort" = "443" ]; then
        nodeUrl="https://$domain"
    else
        nodeUrl="https://$domain:$apiPort"
    fi
else
    nodeUrl="N/A"
fi

nodeVersion="$(curl -s -X GET "http://localhost:14265/api/v1/info" -H  "accept: application/json"|jq '.data.version')"
if [ -z "$nodeVersion" ]; then
    nodeVersion="N/A"
fi
healthy="$(curl -s -X GET "http://localhost:14265/api/v1/info" -H  "accept: application/json"|jq '.data.isHealthy')"
if [ -z "$healthy" ]; then
    healthy="N/A"
fi

if [ "$nodeUpdate" = "true" ]; then
    nodeUpdateStatus=enabled
else
    nodeUpdateStatus=disabled
fi

# Sync Check
if [ "$checkSync" = "true" ]; then
    checkSyncStatus=enabled
else
    checkSyncStatus=disabled
fi

# Proxy Check
if [ "$proxyCheck" = "true" ]; then
    proxyCheckStatus=enabled
else
    proxyCheckStatus=disabled
fi

if [ -z "$restartDate" ]; then
    restartDate="N/A"
fi

# Log Pruning
if [ "$logPruning" = "true" ]; then
    logPruning=enabled
else
    logPruning=disabled
fi

# Watchdog
crontab -l | grep -q "$watchdogCronCmd" && watchdogStatus=enabled || watchdogStatus=disabled

# DB size
if [ -d "$hornetDir/${network}db" ]; then
    getCurrentDbSize="$(du -sb $hornetDir/${network}db | cut -f1)"
    let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
    if [ "$getCurrentDbSizeInMb" -gt "999" ]; then
        let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
        currentDbSize="$getCurrentDbSizeInGb GB"
    else
        currentDbSize="$getCurrentDbSizeInMb MB"
    fi
else
    currentDbSize="N/A"
fi

if [ "$pruning" = "true" ]; then
    pruningStatus=enabled
else
    pruningStatus=disabled
fi

if [ "$pow" = "true" ]; then
    powStatus=enabled
else
    powStatus=disabled
fi

# OUTPUT
whiptail --title "SWARM Info [v$version]" --msgbox "Hornet: $nodeVersion\nNetwork: $network\nHealthy: $healthy\nPoW: $powStatus\nPruning: $pruningStatus\nDB Pruner: \"$dbPruner\"\nMax DB size: $pruningDatabaseSize GB\nDB size: $currentDbSize\n\nWatchdog: $watchdogStatus\nSWARM updater: $swarmAutoUpdate\nNode updater: $nodeUpdateStatus\nSync-check: $checkSyncStatus\nProxy-check: $proxyCheckStatus\nLogpruning: $logPruning\nLast restart: $restartDate\n\nNode-URL: $nodeUrl" 25 65

