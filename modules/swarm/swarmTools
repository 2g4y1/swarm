#!/bin/bash

CHOICE=$(
    whiptail --title "SWARM - Plugins" --menu "\nChoose an option" 12 65 0 \
    "1)" "Manage Watchdog" \
    "2)" "Manage Firewall" 3>&2 2>&1 1>&3
)
case $CHOICE in
    "2)")
        if [ "$ufw" = "true" ]; then
            firewallStatus=$(ufw status | grep -o "inactive")
            if [ "$firewallStatus" = "inactive" ]; then
                firewall=disabled
            else
                firewall=enabled
            fi
            CHOICE=$(
                whiptail --title "SWARM Menu" --menu "\nFirewall: $firewall\n\nChoose an option" 14 65 0 \
                "1)" "Enable Firewall" \
                "2)" "Disable Firewall" 3>&2 2>&1 1>&3
            )
            case $CHOICE in
                "1)")
                    sudo ufw default deny incoming > /dev/null 2>&1
                    sshPort=$(sudo grep "Port [0-9]" /etc/ssh/sshd_config | awk  '{print $2}')
                    sudo ufw allow $sshPort/tcp > /dev/null 2>&1
                    sudo ufw --force enable > /dev/null 2>&1
                    whiptail --title "SWARM Menu" --msgbox "Firewall successfully activated!" 8 65
                ;;
                "2)")
                    sudo ufw disable > /dev/null 2>&1
                    whiptail --title "SWARM Menu" --msgbox "Firewall successfully deactivated!" 8 65
                ;;
            esac
        else
            whiptail --title "SWARM Menu" --msgbox "Error - No firewall found!" 8 65
        fi
    ;;
esac