#!/bin/bash
status="$(systemctl show -p ActiveState --value $node)"

if [ ! -z "$domain" ]; then
    if [ "$apiPort" = "443" ]; then
        nodeUrl="https://$domain"
    else
        nodeUrl="https://$domain:$apiPort"
    fi
else
    nodeUrl="N/A"
fi

nodeVersion="$(curl -s -X GET "http://localhost:14265/api/v1/info" -H  "accept: application/json"|jq '.data.version')"
if [ -z "$nodeVersion" ]; then
    nodeVersion="N/A"
fi
healthy="$(curl -s -X GET "http://localhost:14265/api/v1/info" -H  "accept: application/json"|jq '.data.isHealthy')"
if [ -z "$healthy" ]; then
    healthy="N/A"
fi

if [ "$nodeUpdate" = "true" ]; then
    nodeUpdateValue=enabled
else
    nodeUpdateValue=disabled
fi

# Sync Check
if [ "$checkSync" = "true" ]; then
    checkSyncValue=enabled
else
    checkSyncValue=disabled
fi

if [ -z "$pruningDate" ]; then
    pruningDate="N/A"
fi

# Proxy Check
if [ "$proxyCheck" = "true" ]; then
    proxyCheckValue=enabled
else
    proxyCheckValue=disabled
fi

if [ -z "$restartDate" ]; then
    restartDate="N/A"
fi

# Log Pruning
if [ "$logPruning" = "true" ]; then
    logPruning=enabled
else
    logPruning=disabled
fi

#DBPruner
if [ "$dbpruner" = "true" ]; then
    checkDbPrunerValue=enabled
else
    checkDbPrunerValue=disabled
fi

if [ "$apiProtection" = "true" ]; then
    apiProtectionValue=enabled
else
    apiProtectionValue=disabled
fi

# DB size
if [ -d "$hornetDir/${network}db" ] && [ "$node" = "hornet" ]; then
    getCurrentDbSize="$(du -sb $hornetDir/${network}db | cut -f1)"
    let getCurrentDbSizeInGb=$getCurrentDbSize/1000000000
    if [ "$getCurrentDbSizeInGb" -le "0" ]; then
        let getCurrentDbSizeInMb=$getCurrentDbSize/1000000
        currentDbSize="$getCurrentDbSizeInMb MB"
    else
        currentDbSize="$getCurrentDbSizeInGb GB"
    fi
else
    currentDbSize="N/A"
fi

# OUTPUT
whiptail --title "SWARM Info [v$version]" --msgbox "Hornet: $nodeVersion\nNetwork: $network\nHealthy: $healthy\nDB size: $currentDbSize\n\nWatchdog: $watchdog\nNode updater: $nodeUpdateValue\nSync-check: $checkSyncValue\nProxy-check: $proxyCheckValue\nLogpruning: $logPruning\nLast restart: $restartDate\n\nDBPruner: $dbPrunerValue\nLast pruning: $pruningDate\n\nNode-URL: $nodeUrl\nProtected API: $apiProtectionValue" 23 65

