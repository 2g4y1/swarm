#!/bin/bash

if [ "$beeVersion" = "[0-9].[3-9].[0-9]" ] || [ "$beeVersion" = "[0-9].[3-9].[0-9]-rc[4-9]" ]; then
    parser="$(jq '.autopeering.enabled' $beeHome/config.chrysalis-$beeNetwork.json)"
    if [ "$parser" != "$beeAutopeeringEnabled" ] && [ ! -z "$beeAutopeeringEnabled" ]; then
        sudo jq '.autopeering.enabled = '$beeAutopeeringEnabled'' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
    parser="$(jq '.autopeering.bindAddress' $beeHome/config.chrysalis-$beeNetwork.json)"
    parser=$(echo $parser | tr -d '"')
    if [ "$parser" != "0.0.0.0:$beeAutopeeringPort" ]; then
        sudo jq '.autopeering.bindAddress = "0.0.0.0:'$beeAutopeeringPort'"' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
else
    parser=$(sed -n '/\[autopeering\]/,/entry_nodes/p' $beeHome/config.chrysalis-$beeNetwork.toml)
    parserAutopeeringEnabled=$(echo $parser | awk '{ print $4}')
    parserAutopeeringAddress=$(echo $parser | awk '{ print $7}' | tr -d '"')

    if [ "$parserAutopeeringEnabled" != "$beeAutopeeringEnabled" ] || [ "$parserAutopeeringAddress" != "0.0.0.0:$beeAutopeeringPort" ]; then
        sed -i '/\[autopeering\]/,/entry_nodes/{//!d}' $beeHome/config.chrysalis-$beeNetwork.toml
        sed -i 's~\[autopeering\]~\[autopeering\]\nenabled = '$beeAutopeeringEnabled'\nbind_address = "0.0.0.0:'$beeAutopeeringPort'"~g' $beeHome/config.chrysalis-$beeNetwork.toml
        restartBee=true
    fi

    
    unset parserAutopeeringEnabled
    unset parserAutopeeringAddress
fi

if [ "$beeAutopeeringEnabled" = "true" ] && [ "$ufw" = "true" ]; then
    sudo ufw allow $beeAutopeeringPort/udp > /dev/null 2>&1
else
    sudo ufw delete allow $beeAutopeeringPort/udp > /dev/null 2>&1
fi

unset parser