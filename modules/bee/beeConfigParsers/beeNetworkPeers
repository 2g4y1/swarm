#!/bin/bash

if [[ $beeVersion = [0-9].[3-9].[0-9] ]] || [[ $beeVersion = [0-9].[3-9].[0-9]-rc[4-9] ]]; then
    if [ ! -z "$beePeer1" ]; then
        parserBeeId1="$(jq '.network.peering.peers [0]' $beeHome/config.chrysalis-$beeNetwork.json)"
        beePeerId1="{ \"address\": \"'$beePeer1'\", \"alias\": \"'$beePeerAlias1'\" }"
    fi
    if [ ! -z "$beePeer2" ]; then
        parserBeeId2="$(jq '.network.peering.peers [1]' $beeHome/config.chrysalis-$beeNetwork.json)"
        beePeerId2="{ \"address\": \"'$beePeer2'\", \"alias\": \"'$beePeerAlias2'\" }"
    fi
    if [ ! -z "$beePeer3" ]; then
        parserBeeId3="$(jq '.network.peering.peers [2]' $beeHome/config.chrysalis-$beeNetwork.json)"
        beePeerId3="{ \"address\": \"'$beePeer3'\", \"alias\": \"'$beePeerAlias3'\" }"
    fi
    if [ ! -z "$beePeer4" ]; then
        parserBeeId4="$(jq '.network.peering.peers [3]' $beeHome/config.chrysalis-$beeNetwork.json)"
        beePeerId1="{ \"address\": \"'$beePeer4'\", \"alias\": \"'$beePeerAlias4'\" }"
    fi
    if [ ! -z "$beePeer5" ]; then
        parserBeeId5="$(jq '.network.peering.peers [4]' $beeHome/config.chrysalis-$beeNetwork.json)"
        beePeerId1="{ \"address\": \"'$beePeer5'\", \"alias\": \"'$beePeerAlias5'\" }"
    fi
    if [ ! -z "$beePeer6" ]; then
        parserBeeId6="$(jq '.network.peering.peers [5]' $beeHome/config.chrysalis-$beeNetwork.json)"
        beePeerId1="{ \"address\": \"'$beePeer6'\", \"alias\": \"'$beePeerAlias6'\" }"
    fi

    # EMPTY ARRAY
    sudo jq '.network.peering.peers = []' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json

    # SET NEW PEERS
    if [ "$parserBeeId1" != "$beePeerId1" ] && [ ! -z "$beePeer1" ]; then
        sudo jq '.network.peering.peers [0] |= . + { "address": "'$beePeer1'", "alias": "'$beePeerAlias1'" }' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
    if [ "$parserBeeId2" != "$beePeerId2" ] && [ ! -z "$beePeer2" ]; then
        sudo jq '.network.peering.peers [1] |= . + { "address": "'$beePeer2'", "alias": "'$beePeerAlias2'" }' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
    if [ "$parserBeeId3" != "$beePeerId3" ] && [ ! -z "$beePeer3" ]; then
        sudo jq '.network.peering.peers [2] |= . + { "address": "'$beePeer3'", "alias": "'$beePeerAlias3'" }' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
    if [ "$parserBeeId4" != "$beePeerId4" ] && [ ! -z "$beePeer4" ]; then
        sudo jq '.network.peering.peers [3] |= . + { "address": "'$beePeer4'", "alias": "'$beePeerAlias4'" }' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
    if [ "$parserBeeId5" != "$beePeerId5" ] && [ ! -z "$beePeer5" ]; then
        sudo jq '.network.peering.peers [4] |= . + { "address": "'$beePeer5'", "alias": "'$beePeerAlias5'" }' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
    if [ "$parserBeeId6" != "$beePeerId6" ] && [ ! -z "$beePeer6" ]; then
        sudo jq '.network.peering.peers [5] |= . + { "address": "'$beePeer6'", "alias": "'$beePeerAlias6'" }' $beeHome/config.chrysalis-$beeNetwork.json|sponge $beeHome/config.chrysalis-$beeNetwork.json
        restartBee=true
    fi
    # DELETE NULL
    sudo sed -i '/null,/d' $beeHome/config.chrysalis-$beeNetwork.json
    sudo sed -i '/null/d' $beeHome/config.chrysalis-$beeNetwork.json
    # UNSET VARS
    unset parserBeeId1 parserBeeId2 parserBeeId3 parserBeeId4 parserBeeId5 parserBeeId6 beePeerId1 beePeerId2 beePeerId3 beePeerId4 beePeerId5 beePeerId6
else
    if [ -z "$beePeer1" ]; then
        unsetBeePeer1="#"
    fi
    if [ -z "$beePeer2" ]; then
        unsetBeePeer2="#"
    fi
    if [ -z "$beePeer3" ]; then
        unsetBeePeer3="#"
    fi
    if [ -z "$beePeer4" ]; then
        unsetBeePeer4="#"
    fi
    if [ -z "$beePeer5" ]; then
        unsetBeePeer5="#"
    fi
    if [ -z "$beePeer6" ]; then
        unsetBeePeer6="#"
    fi

    if grep -q "\[autopeering\]" $beeHome/config.chrysalis-$beeNetwork.toml
    then
        parserBefore=$(sed -n '/\[network\.peering\]/,/\[autopeering\]/p' $beeHome/config.chrysalis-$beeNetwork.toml)
        sed -i '/\[network\.peering\]/,/\[autopeering\]/{//!d}' $beeHome/config.chrysalis-$beeNetwork.toml
        sed -i 's~\[network\.peering\]~\[network\.peering\]\n'$unsetBeePeer1'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer1'address  = "'$beePeer1'"\n'$unsetBeePeer1'alias    = "'$beePeerAlias1'"\n'$unsetBeePeer2'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer2'address  = "'$beePeer2'"\n'$unsetBeePeer2'alias    = "'$beePeerAlias2'"\n'$unsetBeePeer3'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer3'address  = "'$beePeer3'"\n'$unsetBeePeer3'alias    = "'$beePeerAlias3'"\n'$unsetBeePeer4'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer4'address  = "'$beePeer4'"\n'$unsetBeePeer4'alias    = "'$beePeerAlias4'"\n'$unsetBeePeer5'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer5'address  = "'$beePeer5'"\n'$unsetBeePeer5'alias    = "'$beePeerAlias5'"\n'$unsetBeePeer6'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer6'address  = "'$beePeer6'"\n'$unsetBeePeer6'alias    = "'$beePeerAlias6'"\n~g' $beeHome/config.chrysalis-$beeNetwork.toml
        parserAfter=$(sed -n '/\[network\.peering\]/,/\[autopeering\]/p' $beeHome/config.chrysalis-$beeNetwork.toml)
    else
        parserBefore=$(sed -n '/\[network\.peering\]/,/\[protocol\]/p' $beeHome/config.chrysalis-$beeNetwork.toml)
        sed -i '/\[network\.peering\]/,/\[protocol\]/{//!d}' $beeHome/config.chrysalis-$beeNetwork.toml
        sed -i 's~\[network\.peering\]~\[network\.peering\]\n'$unsetBeePeer1'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer1'address  = "'$beePeer1'"\n'$unsetBeePeer1'alias    = "'$beePeerAlias1'"\n'$unsetBeePeer2'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer2'address  = "'$beePeer2'"\n'$unsetBeePeer2'alias    = "'$beePeerAlias2'"\n'$unsetBeePeer3'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer3'address  = "'$beePeer3'"\n'$unsetBeePeer3'alias    = "'$beePeerAlias3'"\n'$unsetBeePeer4'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer4'address  = "'$beePeer4'"\n'$unsetBeePeer4'alias    = "'$beePeerAlias4'"\n'$unsetBeePeer5'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer5'address  = "'$beePeer5'"\n'$unsetBeePeer5'alias    = "'$beePeerAlias5'"\n'$unsetBeePeer6'\[\[network\.peering\.peers\]\]\n'$unsetBeePeer6'address  = "'$beePeer6'"\n'$unsetBeePeer6'alias    = "'$beePeerAlias6'"\n~g' $beeHome/config.chrysalis-$beeNetwork.toml
        parserAfter=$(sed -n '/\[network\.peering\]/,/\[protocol\]/p' $beeHome/config.chrysalis-$beeNetwork.toml)
    fi

    if [ "$parserBefore" != "$parserAfter" ]; then
        restartBee=true
    fi
fi